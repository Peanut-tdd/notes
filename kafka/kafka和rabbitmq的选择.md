

## kafka和rabbitmq的选择



我们的系统现在使用的消息中间件主要是kafka，某些功能还使用了redis来做队列。
从成本和系统稳定性上考虑，我们引入新的消息队列：RabbitMQ

整体原则：

1. 在新业务中开始使用RabbitMQ，老业务在项目迭代中逐渐调整为RabbitMQ
2. 全面取消redis做队列的方案，老业务在项目迭代中逐渐调整为RabbitMQ，核心业务使用redis做队列时需要专项调整为RabbitMQ
3. 当数据只提供给单一消费者订阅时，使用RabbitMQ。当数据提供给多方消费者订阅时，使用kafka。


以下的使用场景供选型参考：

**kafka：单机QPS是百万级别**

1. 当消息需要保证严格的先后顺序时，使用kafka。比如订单创建、订单付款、订单发货的单向顺序
2. 当需要通过事件重放来排查问题或补数据时，使用kafka。比如某段时间学习系统消费算法事件异常时，可以通过设置偏移量重新消费数据进行事件补充
3. 当消息消费错误后不需要重试时，即无所谓数据准确性时，使用kafka。
4. 当功能需要支持较大吞吐量时，使用kafka。比如学生做题记录、错题记录


**RabbitMQ：单机QPS是万级别** 

1. 当消息需要使用匹配规则进行分发时，使用RabbitMQ。比如规则a的数据分发给a系统，规则b的数据分发给b系统
2. 当数据吞吐量不大时，需要对消息消费错误时进行重试时，使用RabbitMQ。
3. 当需要使用延迟队列时，使用RabbitMQ。比如订单15分钟内未支付需要自动取消订单
4. 当需要使用优先级队列时，使用RabbitMQ。比如任务调度时，高优先级任务需要优先执行
5. 当业务数据需要进行系统间解耦时，使用RabbitMQ。



没有最好的技术，只有最合适的技术。
我们根据自己的业务特征，选取合适的消息队列就好。