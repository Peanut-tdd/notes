# 普通hash和一致性hash算法

使用场景：nginx 负载均衡ip_hash,分布式数据存储



### 普通hash用法：

以缓存图片为例

```
图片名称计算hash，按服务器数量取模
hash(图片)%N   //N为服务器数量
```

nginx负载均衡实现与上面一致

缺点：

扩展性和容错性较差，如果服务器的数量发生改变，取模计算的结果值页会发生改变，无法找到对应的服务器，查询失效





### 一致性hash算法

对2^32次方取模，将hash空间按顺时针方向组织一个虚拟的圆环，即hash环

```
服务器ip计算hash，对2^32次方取模，确定在hash环上的位置
图片名称计算hash，对2^32次方取模，确定在hash环上位置，顺时针查找，遇到的第一个服务器位置即时要存储的位置
```

优点：

取模是固定不变的，服务器数量的增加和减少只会影响环上部分数据的查找，不至于把所有的压力全部集中到后端数据库，防止了缓存雪崩，具有良好的扩展性和容错性。





### hash环的倾斜和处理方法

在服务器节点的数量较少的情况下，缓存对象集中在某一台服务器上，从而出现数据分部不均匀的情况，这就称为has环的倾斜

为了解决倾斜问题，一致性hash引入了虚拟节点机制，即对物理节点计算多个hash值，映射到hash环上，虚拟节点越多，数据被均匀分布的概率就越大。具体方法是给物理节点加编号，做好物理节点和虚拟节点的映射关系。





### 为什么一致性hash是圆形的？

假如在2^32-2处有一个数据，但是在2^32-2至2^32次方没有服务器节点，那么2^32次方应该落在哪里？











$$

$$





