# 分库分表相关



## 1.分库分表场景



### 1.1单库性能瓶颈，需要分库

+ 数据库服务器磁盘空间或内存空间不足，且无法扩容，导致读写性能瓶颈

+ 数据库服务器CPU压力大，无法升配，导致读写性能瓶颈

+ 数据库服务器网络带宽不足，无法升配，导致读写性能瓶颈

+ 数据库服务器连接数过多，无法升配，导致读写性能瓶颈

  

### 1.2单表性能瓶颈，需要分表

* 单表数据量过大



### 1.3微服务化

架构需求，业务需要微服务化，按照不同的域划分管理数据库，对数据库进行物理和权限隔离，从而进行分库分表，如用户中心数据库，订单中心数据库，xx中心数据库等







## 2.分库分表策略



### 2.1Range范围拆分



**优点**

方便扩容，每次数据量达到range值后就新建一张表，可以实现自动化扩容

**缺点**

存在写偏移，出现尾部热点





## 2.2hash取模拆分

**优点**

数据分片均匀，降低尾部热点问题

**缺点**

后期扩容需要迁移数据；数据被切分到不同的库表中，可能存在节点查询和分页问题



## 2.3映射表

按业务将分表键和对应数据库做对应关系映射，放在单独的表中

**优点**

可以灵活配置路由

**缺点**

随着业务量的增加，可能需要进一步分库分表







### 3.分库分表如何落地

**场景：电商项目下每日3000W下单场景**

**评估库和表的总数**

一般评估标准：当日订单峰值M * 支持最大的爆发增长率R * 业务支撑年限 *365天，单表存储在1000w条数据。

预估数据总数：Total=3000w*365天 * 10倍增长率*10年业务支撑≈10000万亿

评估数据表总数：10000万亿/1000万=10w。大概需要10万个表，组合方式有【1个库10万张表，10个库1万张表，100个库1000张表】，最终选择100个库1000张表。



**订单分库分表字段选择，应对高并发查询**

**订单分库分表字段选择：**

分库：按区域位置编码映射分库

分表：

+ 用户视角，按用户user_id分表
+ 商家视角，按商家id分表
+ 客服视角，按订单号分表



**应对高并发查询：**

冗余数据和关系索引表

**冗余数据：**用空间换时间，将订单表写到4种维度的表中

**关系索引表：**uong时间换空间，建立查询条件与基表分表键的索引关联关系，如建立用户id和订单id的关联关系表，商家id和订单id的关联关系表







**疑问**

疑问1：时间维度的查询怎么办

可以同步到elasticsearch



疑问2：10年后的数据怎么存储

按时间划分，进行冷热数据分离，新数据放在mysql里，老数据放在elasticsearch中



















