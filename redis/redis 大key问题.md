# redis大key问题

redis大key实际上是存储的数据value过大，`没有删除和过期机制，或者数据没有进行分片，将大key分成小key`，导致查询速度较慢

### redis 大key出出现场景

1：社交类，某明星或者大v粉丝列表

2：统计类：如统计每个歌曲的收藏人数列表（redis set）

3：缓存：将数据从数据库load出来序列化后放入redis中



### redis大key引发的问题

1:**客户端超时阻塞**，redis是单线程操作，操作大key时比较耗时，意味着阻塞redis的可能性比较大，这样会造成客户端阻塞或者故障切换，出现redis慢查询

2:**内存空间不均匀**，分布式系统中分片数据不均匀，cpu使用不平衡

3:**网络阻塞**，如一个大key的大小为1MB,每秒访问量为1000，那么每秒产生1000MB的流量，对于普通千兆网络来说是灾难

4:**工作线程阻塞**，删除大key时，可能会阻塞线程





### redis大key如何检测

1:增加内存&流量&超时等指标的监控

2：redis-cli --bigkeys,可以找到redis实例5中数据类型的最大key

3：redis-rdb-tools离线分析工具来扫描RDB持久化文件





### redis大key的处理与优化

#### 1:redis大key删除

1.1:渐进式批量删除scan(redis4.0之前)

1.2:惰性删除 unlink（异步非阻塞）





#### redis大key优化

1：业务角度考虑，value只存储有用的字段

2：对value进行压缩

3：大key拆分成小key，使用multiGet获取值

4：数据扩容分片，使用hash算法

