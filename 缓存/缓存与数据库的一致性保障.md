# 缓存与数据库的一致性保障

### 方案一：延迟双删

```
先删除缓存
更新数据
延迟一定时间再删除缓存
```

问题：无法控制再次删除缓存的延迟时间，当存在数据库主从同步时，如a=1,主数据库更新了a=2，但是新数据还未同步到从数据库，从服务器数据还是a=1,缓存a=1；造成真实数据和缓存数据不一致。



### 方案二：异步监听binlog删除缓存

```
更新主数据库数据a=2
异步监听binlog删除缓存（带MQ重试机制，保证缓存删除）
查询从库a=1,并将数据写入缓存a=1(脏数据)
主数据库数据同步到从数据库a=2

```

问题：和方案一一样依然存在脏数据



### 方案三：缓存三重删除+数据一致性校验+更新流程禁用缓存+强制读取redis主节点

```
更新数据库库同步删除缓存
异步监听binlog删除缓存，带重试机制，保证缓存一定被删除
缓存设置过期时间，过期后自动删除，越近更新的数据缓存时间越短（并发）
监听数据库binlog延迟N秒后进行数据一致校验
更新操作禁止读缓存
强制读取redis主节点
```







